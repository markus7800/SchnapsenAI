<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<style>
.header1 { grid-area: header; }
.opponent2 { grid-area: opponent; }
.playarea3 { grid-area: playarea; }
.player4 { grid-area: player; }
.remainingcard5 { grid-area: remainingcards; }
.footer6 { grid-area: footer; }
.buttons6 { grid-area: buttons; }

.grid-container {
  display: grid;
  grid-template-areas:
    'header header header'
    'opponent opponent remainingcards'
    'playarea playarea remainingcards'
    'player player remainingcards'
    'footer footer buttons';
  gap: 10px;
  padding: 0px;
}


.grid-container > div {
  text-align: center;
  padding: 0px 0;
  font-size: 20px;
}


.card-container {
  display: grid;
  grid-template-columns: auto auto auto auto auto;
  padding: 0px;
}

.handcard-container {
  display: grid;
  grid-template-columns: auto auto auto auto auto auto;
  padding: 0px;
}

.handcard-item, .player-item, .opponent-item, .lastatout-item, .talon-item, .played-card-item, .respond-card-item {
  padding: 5px;
  font-size: 10px;
  text-align: center;
}

.remainingcard-item, .suit-item, .unkowncard-item {
  padding: 2px;
  font-size: 10px;
  text-align: center;
}

img {
  width: 100%;
}

body {
  width: min(140vh,95vw);
}

</style>
</head>
<body>

<div class="grid-container">
  <div class="header1"><h3>Schnapsen Interface</h3></div>
  <div class="opponent2">
    <div class="handcard-container">
      <div class="handcard-item"><h2 id="opponent_score">Score:<br>0</h2></div>
      <div class="opponent-item"><img id="opponent_hand_1" src="cards/unkown_card.png"></div>
      <div class="opponent-item"><img id="opponent_hand_2" src="cards/unkown_card.png"></div>
      <div class="opponent-item"><img id="opponent_hand_3" src="cards/unkown_card.png"></div>
      <div class="opponent-item"><img id="opponent_hand_4" src="cards/unkown_card.png"></div>
      <div class="opponent-item"><img id="opponent_hand_5" src="cards/unkown_card.png"></div>
    </div>
  </div>
  <div class="playarea3">
    <div class="handcard-container">
      <div class="handcard-item"><h2 style="visibility: hidden;">Score:<br>0</h2></div>
      <div class="played-card-item"><img onclick="clickCard(this.id)" id="play_area_1" src="cards/unkown_card.png"></div>
      <div class="respond-card-item"><img id="play_area_2" src="cards/no_card.png"></div>
      <div class="handcard-item"><img id="no_card" src="cards/no_card.png"></div>
      <div class="lastatout-item"><img onclick="clickCard(this.id)" id="play_area_4" src="cards/unkown_card.png"></div>
      <div class="talon-item"><img onclick="clickCard(this.id)" id="play_area_5" src="cards/unkown_card.png"></div>
    </div>
  </div>
  <div class="player4">
    <div class="handcard-container">
      <div class="handcard-item"><h2 id="player_score">Score:<br>0</h2></div>
      <div class="player-item"><img onclick="clickCard(this.id)" id="player_hand_1" src="cards/unkown_card.png"></div>
      <div class="player-item"><img onclick="clickCard(this.id)" id="player_hand_2" src="cards/unkown_card.png"></div>
      <div class="player-item"><img onclick="clickCard(this.id)" id="player_hand_3" src="cards/unkown_card.png"></div>
      <div class="player-item"><img onclick="clickCard(this.id)" id="player_hand_4" src="cards/unkown_card.png"></div>
      <div class="player-item"><img onclick="clickCard(this.id)" id="player_hand_5" src="cards/unkown_card.png"></div>
    </div>
  </div>
  <div class="remainingcard5">
    <div class="card-container">
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="clubs_jack" src="cards/clubs_jack.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="clubs_queen" src="cards/clubs_queen.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="clubs_king" src="cards/clubs_king.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="clubs_ten" src="cards/clubs_ten.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="clubs_ace" src="cards/clubs_ace.png"></div>

      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="hearts_jack" src="cards/hearts_jack.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="hearts_queen" src="cards/hearts_queen.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="hearts_king" src="cards/hearts_king.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="hearts_ten" src="cards/hearts_ten.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="hearts_ace" src="cards/hearts_ace.png"></div>

      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="spades_jack" src="cards/spades_jack.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="spades_queen" src="cards/spades_queen.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="spades_king" src="cards/spades_king.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="spades_ten" src="cards/spades_ten.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="spades_ace" src="cards/spades_ace.png"></div>

      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="diamonds_jack" src="cards/diamonds_jack.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="diamonds_queen" src="cards/diamonds_queen.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="diamonds_king" src="cards/diamonds_king.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="diamonds_ten" src="cards/diamonds_ten.png"></div>
      <div class="remainingcard-item"><img onclick="clickCard(this.id)" id="diamonds_ace" src="cards/diamonds_ace.png"></div>

      <div class="suit-item"><img onclick="clickCard(this.id)" id="call_clubs" src="cards/clubs.png"></div>
      <div class="suit-item"><img onclick="clickCard(this.id)" id="call_hearts" src="cards/hearts.png"></div>
      <div class="suit-item"><img onclick="clickCard(this.id)" id="call_spades" src="cards/spades.png"></div>
      <div class="suit-item"><img onclick="clickCard(this.id)" id="call_diamonds" src="cards/diamonds.png"></div>
      <div class="unkowncard-item"><img onclick="clickCard(this.id)" id="unkown_card" src="cards/unkown_card.png"></div>

    </div>
    <button type="button" id="engine_button" onclick="engine()">Run Engine</button>
    <button type="button" id="confirm_button" onclick="confirm()">Confirm</button>
  </div>
  <div class="footer6" id="footer">Footer</div>
  <div class="footer7">
    <!-- <button type="button" name="new" onclick="location.reload()">New Game</button> -->
  </div>
</div>

<script type="text/javascript">
  const selectionColor = "#00ff00"


  var state = "newgame"

  var player_selection = ""
  var card_selection = ""
  var played_card_selection = ""
  var respond_card_selection = ""
  var suit_selection = ""
  var lastatout_selected = false
  var talon_selected = false

  function toggleSelectCard(card_id, color) {
    console.log("toggleSelectCard", card_id)
    id = card_id
    card_image = document.getElementById(id);
    parentDiv = card_image.parentElement;

    classGroup = [parentDiv.className]
    if (state == "newgame") {
      classGroup = ["played-card-item", "lastatout-item", "player-item"]
    } else if (state == "mymove") {
    }

    if (classGroup.some(el => el == parentDiv.className)) {
      deselect(classGroup, card_image)
    } else {
      deselect([parentDiv.className], card_image)
    }


    if (parentDiv.style.backgroundColor != "") {
      // deselect
      deselectClass(parentDiv.className)
      parentDiv.style.backgroundColor = ""
      console.log("Deselect", {
        "player_selection": player_selection,
        "card_selection": card_selection,
        "respond_card_selection": respond_card_selection,
        "played_card_selection": played_card_selection,
        "lastatout_selected": lastatout_selected,
        "talon_selected": talon_selected,
        "suit_selection": suit_selection
      })

    } else {
      // select
      selectClass(parentDiv.className)
      parentDiv.style.backgroundColor = color
      console.log("Select", {
        "player_selection": player_selection,
        "card_selection": card_selection,
        "respond_card_selection": respond_card_selection,
        "played_card_selection": played_card_selection,
        "lastatout_selected": lastatout_selected,
        "talon_selected": talon_selected,
        "suit_selection": suit_selection
      })
    }
  }

  function deselectClass(className) {
    switch(className) {
      case "player-item":
        player_selection = ""; break;
      case "remainingcard-item":
        card_selection = ""; break;
      case "unkowncard-item":
        card_selection = ""; break;
      case "played-card-item":
        played_card_selection = ""; break;
      case "respond-card-item":
        respond_card_selection = ""; break;
      case "lastatout-item":
        lastatout_selected = false; break;
      case "talon-item":
        talon_selected = false; break;
      case "suit-item":
        suit_selection = ""; break;
      default:
        console.log("Invalid card class.", parentDiv.className); break;
    }
  }

  function selectClass(className) {
    switch(className) {
      case "player-item":
        player_selection = id; break;
      case "remainingcard-item":
        card_selection = id; break;
      case "unkowncard-item":
        card_selection = id; break;
      case "played-card-item":
        played_card_selection = id; break;
      case "respond-card-item":
        respond_card_selection = id; break;
      case "lastatout-item":
        lastatout_selected = true; break;
      case "talon-item":
        talon_selected = true; break;
      case "suit-item":
        suit_selection = id; break;
      default:
        console.log("Invalid card class.", parentDiv.className); break;
    }
  }

  function deselect(classNames, except) {
    for (const className of classNames) {
      deselectClass(className)
      elements = document.getElementsByClassName(className);
      for (var i = 0; i < elements.length; i++) {
        if (!elements[i].contains(except)) {
          elements[i].style.backgroundColor = "";
        }
      }
    }
  }

  function disableClick(classNames) {
    for (const className of classNames) {
      elements = document.getElementsByClassName(className);
      for (var i = 0; i < elements.length; i++) {
        elements[i].firstChild.onclick = false;
      }
    }
  }

  function enableClick(classNames) {
    for (const className of classNames) {
      elements = document.getElementsByClassName(className);
      for (var i = 0; i < elements.length; i++) {
        elements[i].firstChild.onclick = function() { clickCard(this.id) };
      }
    }
  }

  const allClassNames = [
    "player-item",
    "remainingcard-item",
    "unkowncard-item",
    "lastatout-item",
    "talon-item",
    "suit-item",
    "played-card-item",
    "respond-card-item"
  ]

  function deselectAll() {
    deselect(allClassNames)
  }

  function clickCard(id) {
    console.log("click", id);
    toggleSelectCard(id, selectionColor)
    selectionHandler()
  }

  const suit_to_symbol = {
    "clubs": "C",
    "hearts": "H",
    "spades": "S",
    "diamonds": "D"
  }

  const face_to_symbol = {
    "ten": "10",
    "jack": "J",
    "queen": "Q",
    "king": "K",
    "ace": "A"
  }

  function symbolFromId(id) {
    if (id == "unkown_card") {
      return ""
    }
    split_id = id.split("_")
    suit = split_id[0]
    face = split_id[1]
    return face_to_symbol[face] + suit_to_symbol[suit]
  }

  function hideCard(card_id) {
    card_image = document.getElementById(card_id);
    if (card_image != null) {
      card_image.style.opacity = 0.1
      card_image.onclick = false
    } else {
      console.log("Card", card_id, "not found.")
    }
  }

  function showCard(card_id) {
      card_image = document.getElementById(card_id);
      if (card_image != null) {
        card_image.style.opacity = 1.0
        card_image.onclick = function() { clickCard(this.id) }
      } else {
        console.log("Card", card_id, "not found.")
      }
  }

  function showGameCard(card_id) {
    card_image = document.getElementById(card_id);
    if (card_image != null) {
      card_image.style.visibility = "visible"
    } else {
      console.log("Card", card_id, "not found.")
    }
  }

  function hideGameCard(card_id) {
    card_image = document.getElementById(card_id);
    if (card_image != null) {
      card_image.style.visibility = "hidden"
    } else {
      console.log("Card", card_id, "not found.")
    }
  }

  function isGameCardHidden(card_id) {
    card_image = document.getElementById(card_id);
    return card_image.style.visibility == "hidden"
  }

  function getIdFromSrcName(srcName) {
    //"card/suit_face.png"
    fileName = srcName.split("cards")[1]
    id = fileName.slice(1, fileName.length-4)
    return id
  }

  function selectionHandler() {
    if (state == "newgame") {
      console.log("selectionHandler", state, card_selection, player_selection, lastatout_selected, played_card_selection)

      if (card_selection != "") {
        var other_selection = ""
        if (player_selection != "") {
          other_selection = player_selection
        } else if (lastatout_selected) {
          other_selection = "play_area_4"
        } else if (played_card_selection) {
          other_selection = "play_area_1"
        }
        if (other_selection != "") {
          if (card_selection != "unkown_card") {
            hideCard(card_selection)
          }

          other_card_image = document.getElementById(other_selection)
          card_selection_image = document.getElementById(card_selection)

          showCard(getIdFromSrcName(other_card_image.src))
          other_card_image.src = card_selection_image.src

          toggleSelectCard(other_selection)
          toggleSelectCard(card_selection)

          if (other_selection.includes("player_hand")) {
            i = parseInt(other_selection.split("player_hand_")[1])
            if (i < 5) {
              toggleSelectCard("player_hand_" + (i+1), selectionColor)
            } else {
              toggleSelectCard("play_area_4", selectionColor)
            }
          }
        }
      }
    }
  }

  function newgame() {
    console.log("newgame")
    document.getElementById("engine_button").disabled = true

    state = "newgame"

    disableClick(allClassNames)
    enableClick(["played-card-item", "lastatout-item", "player-item", "remainingcard-item", "unkowncard-item", "talon-item", "suit-item"])

    setFooterMsg("Input your hand, atout card, and first opponent move if necessary.")
    toggleSelectCard("player_hand_1", selectionColor)
  }

  function mymove() {
    console.log("mymove")
    document.getElementById("engine_button").disabled = false

    state = "mymove"
    disableClick(allClassNames)
    enableClick(["lastatout-item", "player-item", "suit-item", "talon-item"])

    setFooterMsg("Input your move.  Click talon for lock, atout for swap, suit for call, your hand for played card. Click 'Run Engine' for best move.")
  }

  function oppmove() {
    console.log("oppmove")
    document.getElementById("engine_button").disabled = true

    state = "oppmove"
    deselectAll()
    disableClick(allClassNames)
    enableClick(["lastatout-item", "remainingcard-item", "suit-item", "talon-item"])

    setFooterMsg("Input opponent move. Click talon for lock, atout for swap, suit for call, remaining cards for played card.")
  }

  function drawcard() {
    console.log("drawcard")
    document.getElementById("engine_button").disabled = true

    state = "drawcard"
    deselectAll()
    disableClick(allClassNames)
    enableClick(["remainingcard-item"])

    setFooterMsg("Select drawn card.")
  }

  function setFooterMsg(msg) {
      footer = document.getElementById("footer")
      footer.innerHTML = msg
  }

  function gameover() {
    console.log("gameover")
    document.getElementById("engine_button").disabled = true

    state = "gameover"
    disableClick(allClassNames)
    setFooterMsg("Game over.")
  }

  function setCard(card_id, card_name) {
    card_image = document.getElementById(card_id);
    card_image.src = document.getElementById(card_name).src
  }

  function setupGameFromJson(gamejson) {
    for (var i = 1; i <= 5; i++) {
      if (i <= gamejson.n_opphand) {
        showGameCard("opponent_hand_" + i)
      } else {
        hideGameCard("opponent_hand_" + i)
      }
      if (i <= gamejson.hand.length) {
        showGameCard("player_hand_" + i)
        setCard("player_hand_" + i, gamejson.hand[i-1])
      } else {
        hideGameCard("player_hand_" + i)
      }
    }

    setCard("play_area_1", gamejson.played_card)
    if (gamejson.is_locked) {
      setCard("play_area_4", "no_card")
      setCard("play_area_5", gamejson.last_atout)
    } else {
      setCard("play_area_4", gamejson.last_atout)
    }

    if (gamejson.n_talon == 0) {
      setCard("play_area_4", "no_card")
      setCard("play_area_5", "no_card")
    }

    elements = document.getElementsByClassName("remainingcard-item");
    for (var i = 0; i < elements.length; i++) {
      hideCard(elements[i].firstChild.id)
    }
    for (var i = 0; i < gamejson.remaining_cards.length; i++) {
      showCard(gamejson.remaining_cards[i])
    }

    document.getElementById("opponent_score").innerHTML = "Score:<br>" + gamejson.opponent_score
    document.getElementById("player_score").innerHTML = "Score:<br>" + gamejson.player_score

    if (gamejson.is_gameover) {
      gameover()
    } else {
      if (gamejson.next == "me") {
        mymove()
      } else if (gamejson.next == "opponent") {
        oppmove()
      } else if (gamejson.next == "drawcard") {
        drawcard()
      } else {
        console.log("Unkown next step: ", gamejson.next)
      }
    }
  }

  function engine() {
    console.log("engine")

    deselectAll()

    if (state != "mymove") { return }

    setFooterMsg("...")
    $.get("/engine", function(response) {
      r = JSON.parse(response)
      console.log(r)
      if (r.ok) {
        for (var i=1; i <= 5; i++) {
          card_img = document.getElementById("player_hand_" + i)
          if (card_img.src.includes(r.card) && !isGameCardHidden(card_img.id)) {
            toggleSelectCard(card_img.id, selectionColor)
          }
        }
        if (r.lock) {
          toggleSelectCard("play_area_5", selectionColor)
        }
        if (r.swap) {
          toggleSelectCard("play_area_4", selectionColor)
        }
        if (r.call) {
          if (r.card.includes("clubs")) {
            toggleSelectCard("call_clubs", selectionColor)
          } else if (r.card.includes("hearts")) {
            toggleSelectCard("call_hearts", selectionColor)
          } else if (r.card.includes("spades")) {
            toggleSelectCard("call_spades", selectionColor)
          } else if (r.card.includes("diamonds")) {
            toggleSelectCard("call_diamonds", selectionColor)
          }
        }

        setFooterMsg("Engine evaluation : winning probability = " + (1 - r.losing_probability) + ".")
      }
    })
  }

  function confirm() {
    console.log("confirm", state)
    
    if (state == "newgame") {
      hand = ""
      elements = document.getElementsByClassName("player-item");
      for (var i = 0; i < elements.length; i++) {
        id = getIdFromSrcName(elements[i].firstChild.src)
        hand += symbolFromId(id)
        if (i < 4) { hand += " " }
      }
      console.log("hand", hand)

      srcname = document.getElementById("play_area_4").src
      atout = symbolFromId(getIdFromSrcName(srcname))

      srcname = document.getElementById("play_area_1").src
      opponent_move = symbolFromId(getIdFromSrcName(srcname))
      call = suit_selection != ""
      lock = talon_selected
      swap = lastatout_selected

      setFooterMsg("...")
      const payload = {"hand": hand, "atout": atout, "oppmove": opponent_move, "lock": lock, "call": call, "swap": swap}
      console.log("/newgame", payload)
      $.get("/newgame", payload, function(response) {
        r = JSON.parse(response)
        console.log(r)
        if (r.ok) {
          setupGameFromJson(r.game)
          deselectAll()
        }
      });
    }

    if (state == "mymove") {
      console.log("mymove", {
        "player_selection": player_selection,
        "card_selection": card_selection,
        "respond_card_selection": respond_card_selection,
        "played_card_selection": played_card_selection,
        "lastatout_selected": lastatout_selected,
        "talon_selected": talon_selected,
        "suit_selection": suit_selection
      })

      card = symbolFromId(getIdFromSrcName(document.getElementById(player_selection).src))
      call = suit_selection != ""
      lock = talon_selected
      swap = lastatout_selected

      setFooterMsg("...")
      const payload = {"card": card, "lock": lock, "call": call, "swap": swap}
      console.log("/mymove", payload)
      $.get("/mymove", payload, function(response) {
        r = JSON.parse(response)
        console.log(r)
        if (r.ok) {
          setupGameFromJson(r.game)
          deselectAll()
        }
      });
    }

    if (state == "drawcard") {
      card = symbolFromId(getIdFromSrcName(document.getElementById(card_selection).src))

      setFooterMsg("...")
      const payload = {"card": card}
      console.log("/drawcard", payload)
      $.get("/drawcard", payload, function(response) {
        r = JSON.parse(response)
        console.log(r)
        if (r.ok) {
          setupGameFromJson(r.game)
          deselectAll()
        }
      });
    }

    if (state == "oppmove") {
      console.log("oppmove", {
        "player_selection": player_selection,
        "card_selection": card_selection,
        "respond_card_selection": respond_card_selection,
        "played_card_selection": played_card_selection,
        "lastatout_selected": lastatout_selected,
        "talon_selected": talon_selected,
        "suit_selection": suit_selection
      })

      card = symbolFromId(getIdFromSrcName(document.getElementById(card_selection).src))
      call = suit_selection != ""
      lock = talon_selected
      swap = lastatout_selected

      setFooterMsg("...")
      const payload = {"card": card, "lock": lock, "call": call, "swap": swap}
      console.log("/oppmove", payload)
      $.get("/oppmove", payload, function(response) {
        r = JSON.parse(response)
        console.log(r)
        if (r.ok) {
          setupGameFromJson(r.game)
          deselectAll()
        }
      });
    }
  }

  newgame()

</script>

</body>
</html>
